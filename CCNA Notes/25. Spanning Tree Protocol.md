<img width="428" height="271" alt="image" src="https://github.com/user-attachments/assets/a8c6195e-5a29-4f49-8a95-54898dcc532d" /># Layer 3 Path Selection and Loop Prevention

Network Topology

<img width="481" height="461" alt="image" src="https://github.com/user-attachments/assets/cc0ffc6e-bd13-44d8-860b-34efb280aa37" />

- Layer 3 routing and HSRP control the path selection and provide automatic failover for layer 3 connections

R1 Static Route to SP1 AD of 1
- _ip route 0.0.0.0 0.0.0.0 203.0.113.1_

R1 Backup default static route via R2 AD of 5. In case the route to SP1 fails
- _ip route 0.0.0.0 0.0.0.0 10.10.20.2 5_

R1 interface G0/1 is directly connect to 10.10.10.0/24 AD of 0, because it is a connected route

We will need a backup in case the link from R1 and CD1 goes down.

R1 backup route to 10.10.10.0/24 via R2 AD of 1
- _ip route 10.10.10.0 255.255.255.0 10.10.20.2_

HSRP - Hot Standby Router Protocol

R1
- (config)#_interface 0/1_
- (config-if)#_ip address 10.10.10.2 255.255.255.0_
- (config-if)#_no shutdown_
- (config-if)#_standby 1 ip 10.10.10.1_

R2
- (config)#_interface g0/1_
- (config-if)#_ip address 10.10.10.3 255.255.255.0_
- (config-if)#_no shutdown_
- (config-if)#_standby 1 ip 10.10.10.1_

All the PCs will be using R2 as the active default gateway because of the higher IP address. 10.10.10.3 vs 10.10.10.2

## Routing Loop

- R1(config)#_ip route 10.10.50.0 255.255.255.0 203.0.113.1_
- SP1(config)#_ip route 10.10.50.0 255.255.255.0 203.0.113.10_
- SP2(config)#_ip route 10.10.50.0 255.255.255.0 203.0.113.6_
- R2(config)#_ip route 10.10.50.0 255.255.255.0 10.10.20.1_

Because there is no 10.10.50.0/24 network the routers will be passing this information on to the next hop to look for it. In dynamic routing we have a feature called TTL (time to live) that prevents routing loops. Because after each hop if it can not find the subnet it will subtract from the total of TTL until it reaches 0. Once it reaches 0 the ICMP packet will drop and the traffic stops.


# Why We Have the Spanning Tree Protocol

Because switches deal with broadcast traffic at layer 2, whenever a switch receives an ARP request it will broadcast that traffic through all of its ports except for the port it received the information from. Now in our network topology, since we have multiple switches connected to it, the broadcast traffic will reach all other switches and be in a constant loop with each other. This is called a broadcast storm. Broadcast storms can cause high CPU and high bandwidth which will slow down the network and eventually cause the switches to fail. Because the ethernet header does not have a TTL, the looping will go on forever until we physically unplug the switch itself. STP is protocol that is used to prevent layer 2 loops, it does this by detecting potential loops and blocking ports to prevent loops.

Back to our network topology on Acc3 and Acc4 we have enabled STP on F0/21 and F0/24. This means that these ports are blocked, they can not send or receive any information on those blocked ports. STP automatically detects potential loops in the network and will block those ports. Besides from preventing loops STP also automates failover. So if a link goes down it will automatically turn the blocked port into an active port.

# Spanning Tree - The Root Bridge

The Root Bridge is a designated switch so that STP can be enabled. Now on on switches that are not the root bridge, they will have root ports. The root ports are the ports that are "closest" to the root bridge. The Root Bridge does not have a root port, designated port, or blocked ports.

# How Spanning Tree Works

- STP is an industry standard protcol and it is enabled by default on all vendor's switches
- Switches send Bridge Protocol Data Units (BPDU) out all ports when they come online. These BPDU are used to detect other switches and potential loops.
- The switch will not forward traffic out any port until it is certain it is loop free.

## STP Port States
- When the port first comes online it will be blocking traffic
- STP will detect if the port forms a potential loop and if there is no loop the port will transition from blocking to forwarding
- This process can take up to 50 seconds

## The Bridge ID
- The BPDU contains the switch's Bridge ID which uniquely identifies the switch on the LAN
- The Bridge ID is comprised of the switch's unique MAC address and an administrator defined Bridge Priority Value
- The Bridge Priority can be from 0 - 65535, with 32768 being the default priority.

## The Root Bridge
- A Root Bridge is elected based on the switch's Bridge ID values
- The switch with the lowest Bridge Priority value is preferred, 0 is more preferred than 1
- In the case of a tie the switch with the lowest MAC address will be selected
- The switches build a loop free forwarding path tree leading back to the Root Bridge
- Other switches will detect their lowest cost path to the root bridge and these paths will transition to a forwarding state

## Spanning Tree Cost
- When a switch calculates its best path towards the Root Bridge, higher bandwidth links are preferred.
<img width="621" height="346" alt="image" src="https://github.com/user-attachments/assets/63dd60d2-c691-4ed9-b60d-1fff6686a2d4" />

- Short mode: Short mode is the default setting. It is not granualr enough for today's high bandwidth networks because at 20 Gbps and up, the cost will equal 1. 20Gbps = 10Tbps in cost.
- Long mode: 32-bit Value, which is more granular, up to 20Tbps. If you are using long mode make sure to enable it on all switches in your network.

STP Cost Verification
- #show spanning-tree pathcost method

Then to change STP Cost mode
- (config)#_spanning-tree pathcost method long/short_

- All switches forward traffic on their best (lowest cost) path to the Root Bridge
- Higher cost paths (which could potentially form a loop) are bloked
- The lowest cumulative STP cost across all links to reach the Root Bridge is chosen as a switch's Root Path
- A Root Path Cost is a switch's cumulative cost for a specifiv path to reach the Root Bridge

<img width="710" height="221" alt="image" src="https://github.com/user-attachments/assets/46c7fb95-ba91-414a-b8a1-5322182e3358" />

- SW2 can reach the root bridge with the cost of 4 or via SW3 with a cost of 57 (19+19+19)
- SW3 Will prefer the path across SW2
- SW4 Will block the port to SW3 and SW3 will also block the port to SW4

## Load Balancing

STP does not do load balancing. Lets say for instance if a switch has multiple equal cost paths towards the root bridge, it will select the neighbor switch with the lowest bridge ID.
ACC3 will choose Dist2 over Dist3 because it has a lower MAC address. If we have multiple links from the access switch to the distribution switch, the lowest Port ID as F0/1 will be selected as the root port.

<img width="364" height="316" alt="image" src="https://github.com/user-attachments/assets/0387ab30-deb8-42c8-8c5f-a3861e194915" />

## Root Ports, Designated Ports, and Blocked Ports
- Each switch's exit interface on the lowest cost path to the Root Bridge is selected as its Root Port, and there will only be one Root Port per switch
- Root ports are ports that are pointing towards the root bridge, basically most links that are connected to the Root Bridge
- A Designated Port is a port that points away from the root bridge. So all ports on the root bridge are designated ports.
- BUT if we were to add a switch to Dist2, the new link pointing to Dist2 will now become a root port and opposite of that root port will become a designated port.
- Root ports and their opposing designated ports are the most direct paths to and from the Root Bridge and transition to a forwarding state
- BPDUs continue to be sent over the link from the Designated Port but not the block port
- The easy way to figure out which ports are Root, Designated, and Blocking
    - Determine the Root Bridge first, which switch has the best Bridge ID
    - All ports on the Root Bridge are Designated Ports
    - Determine the Root Ports on the other switches, which will be the lowest cost to the Root Bridge

# Spanning Tree Versions
- Spanning Tree is an industry standard protocol and is enabled by default on all vendor switches
- IEEE open standards
  - 802.1D Spanning Tree Protocol
    - Original Spanning Tree Implementation
  - 802.1w Rapid Spanning Tree Protocol
    - Significantly improved convergence time. Uses on Spanning Treee for all VLANs in the LAN
  - 802.1s Multiple Spanning Tree Protocol
    - Allows Load Balancing, by mapping VLANs into different spanning tree instances for load balancing.
   
- Cisco Versions
  - PVST+ Per VLAN Spanning Tree Plus
    - Cisco enhancements to 802.1D. Uses a separate Spanning Tree instance for every VLAN. This the default on most Cisco switches
  - RPVST+ Rapid Per VLAN Spanning Tree Plus
    - Cisco enhancements to 802.1w RSTP. Significantly improved convergence time over PVST+. Uses a separate Spanning Tree instance for every VLAN.

## MSTP Load Balancing Example
 
<img width="428" height="271" alt="image" src="https://github.com/user-attachments/assets/83015cd0-7021-4c20-8a42-ed14b8bffb77" />

- The access layer switches have PCs attached in multiple VLANs
- CD1 is made the Root Bridge for VLANs 10-19
- Traffic for these VLANs is forwarded on the link to CD1 and blocked on the link to CD2
- CD2 is made the Root Bridge for VLANs 20-29
- Traffic for these VLANs is forwarded on the link to CD2 and blocked on the link to CD1
- Two Spanning Tree instances run, one for each group of VLANs
- In our example up above we will be looking at this from the view of our Acc3 switch. Traffic for the VLANs 10-19 will be going up the link from Acc3 to CD1 and the traffic from 20-29 will go up the link from Acc3 to CD2

- There is a slight difference between MST and RPVST+, in MST the VLANs are all grouped together, while in RPVST+ you have a separate instance for each VLAN. This causes more load on the switch.

## Spanning Tree Version Configuration

- (config)#_spanning-tree mode ?_
  - mst
  - pvst
  - rapid-pvst
- (config)#_spanning-tree summary_
  - This will verify which version of STP is running on the switch
 
 
# Verification of Spanning Tree

# Manipulating the Root Bridge Election

# Spanning Tree and HSRP Alignment

# Portfast, BPDU Guard and Root Guard

# BPDU Filter

# Loop Guard

# PVST+ vs RPVST+ Convergence

# RPVST+ and Hub Interoperability
